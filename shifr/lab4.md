# Лабораторная работа №4: Шифрование алгоритмом Blowfish

## Введение
В данной лабораторной работе мы рассмотрим алгоритм блочного шифра Blowfish, разработанный Брюсом Шнайером в 1993 году. Blowfish отличается высокой криптостойкостью и скоростью шифрования благодаря использованию переменной длины ключа (до 448 бит) и генерации таблиц замены.

### Основные характеристики Blowfish:
- **Блочный шифр**: Работает с блоками данных фиксированной длины (64 бита).
- **Переменная длина ключа**: Длина ключа может варьироваться от 32 до 448 бит.
- **Высокая скорость**: Использует предварительно вычисленные таблицы для ускорения процесса шифрования/дешифрования.

## Структура алгоритма Blowfish
Алгоритм Blowfish состоит из двух основных этапов:
1. **Расширение ключа**
2. **Шифрование/дешифрование данных**

### Этап расширения ключа
На этом этапе исходный ключ преобразуется в матрицу раундовых ключей (P) и матрицу подстановки (S-box). Общий объем этих матриц составляет 4168 байт.

#### Процесс расширения ключа:
1. **Инициализация раундовых ключей и S-блоков**: Используются фиксированные константы, полученные из числа PI.
2. **XOR исходного ключа с раундовыми ключами**: Каждый элемент матрицы P складывается по модулю 2 (XOR) с соответствующими частями исходного ключа.
3. **Шифрование матриц**: Используя текущие значения матриц P и S, производится шифрование 64-битной последовательности нулей. Результат записывается в матрицу P, и процесс повторяется до полного обновления всех элементов P и S.

### Функция итерации (F)
Функция F является "черным ящиком", который преобразует 32-битный вход в 32-битный выход. Она использует матрицы подстановки S1-S4 для нелинейного преобразования данных.

Формула функции F:
F(x) = ((S1[a] + S2[b]) XOR S3[c]) + S4[d]

где:
- a = (x >> 24) & 0xFF
- b = (x >> 16) & 0xFF
- c = (x >> 8) & 0xFF
- d = x & 0xFF

### Шифрование/дешифрование данных
Процесс шифрования и дешифрования данных происходит через сеть Фейстеля, состоящую из 16 раундов. На каждом раунде используется функция F и раундовые ключи P.

#### Принцип работы сети Фейстеля:
1. Исходные данные разбиваются на два равных подблока L0 и R0.
2. Подблок L0 видоизменяется функцией F и складывается по модулю 2 с подблоком R0.
3. Результат становится новым подблоком L1, а старый L0 переходит в R1.
4. Процесс повторяется 16 раз с изменением раундовых ключей.
5. После 16 раундов последние две операции XOR применяются к левому и правому подблокам с ключами P[16] и P[17].

## Реализация алгоритма

### Основные функции программы:

1. **Генерация ключей** (`GenerateKeys`):
   - Используется переданное пользователем значение ключа для создания массива раундовых ключей (P-матрицы).
   - Производится инициализация на основе константных значений PI.
   
2. **Функция F** (`F`):
   - Осуществляет нелинейное преобразование 32-битного входного значения.
   - Использует четыре S-блока для получения итогового результата.
   
3. **Шифрование блока** (`ShifrPart`):
   - Применяет 16 итераций сети Фейстеля.
   - Включает чередование применения функции F и наложения раундовых ключей.
   - После всех раундов происходит финальное XOR-преобразование с последними ключами.

4. **Дешифрование блока** (`DecryptPart`):
   - Аналогично `ShifrPart`, но использует ключи в обратном порядке.
   - Последовательность обменов и операций такая же, но в обратном порядке.

5. **Преобразование строк в блоки (`StringToBlocks`) и обратно (`BlocksToString`)**:
   - Делит входные данные на 64-битные блоки (8 символов).
   - Дополняет блоки при необходимости.

6. **Функции кодирования и декодирования Base64 (`BlocksToByteArray`)**:
   - Конвертирует зашифрованные блоки в удобный для передачи вид (Base64).

### Пример работы программы:
```csharp
string key = "qwertywsfe";
byte[] keyBytes = Encoding.ASCII.GetBytes(key);

Blowfish blow = new Blowfish(BlowfishConstants.P, BlowfishConstants.SBox, keyBytes);

string msg = "smtp server eto ok";

ulong[] msgBlocks = StringToBlocks(msg);

ulong[] encrypted = blow.ShifrMessage(msgBlocks);

string CryptoMsgBase64 = Convert.ToBase64String(BlocksToByteArray(encrypted));
Console.WriteLine("Encrypted message (Base64): " + CryptoMsgBase64);

ulong[] decrypted = blow.DecryptMessage(encrypted);

string decryptedMsg = BlocksToString(decrypted);
Console.WriteLine("Decrypted message: " + decryptedMsg);
```

## Заключение
В результате выполнения данной лабораторной работы была реализована программная версия блочного шифра Blowfish на языке C#. Программа выполняет шифрование и дешифрование данных, используя принципы сети Фейстеля. 

Полученные знания о работе Blowfish позволили глубже понять принципы блочного шифрования, работу S-блоков и раундовых ключей, а также структуру сети Фейстеля. Реализация алгоритма показала его высокую эффективность и гибкость за счет возможности использования ключей разной длины.

